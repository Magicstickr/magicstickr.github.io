<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<!-- three.js library -->
		<script src='lib/three.min.js'></script>
		<script src="lib/ar.js"></script>
		<script src="lib/WebGL.js"></script>
		<script src="lib/OrbitControls.js"></script>
		<script src="lib/chromakey.js"></script>
		<script src="lib/GLTFLoader.js"></script>
		<!-- script for popup message -->
		<script src="lib/sweetalert2.all.min.js"></script>
		<!-- Include a polyfill for ES6 Promises (optional) for IE11, UC Browser and Android browser support -->
		<script src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.js"></script>
		<title>Wine project</title>
	</head>
	<body style='margin : 0px; overflow: hidden; font-family: Monospace;' onload='loadOK(lang)'>
		<!--V 1.1.5 </br>-->
		<div id=time>Time:</div>
		<div id=test></div>
		<script id="vertexShader" type="x-shader/x-vertex">

			varying vec2 vUv;

			void main()
			{
				vUv = uv;
				vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
				gl_Position = projectionMatrix * mvPosition;
			}
		</script>
		<script id="fragmentShader" type="x-shader/x-fragment">

			uniform sampler2D texture;
			uniform vec3 color;

			varying vec2 vUv;

			void main()
			{
				vec3 tColor = texture2D( texture, vUv ).rgb;
				float a = (length(tColor - color) - 0.5) * 50.0;
				gl_FragColor = vec4(tColor, a);
			}
		</script>
		<script>

		// Threejs/ARjs standard variables
		var renderer, arWorldRoot, onRenderFcts, camera, controls;
		// Object variables
		var all, videoPlane, floor, video, gltfObj, pic1, pic2, pic3, groupButton, health, pairing, coinfo;

		var lang = "eng";
		var startVideo = 2;
		var startPic1 = 21;
		var startPic2 = 26;
		var startButton = 38;

		initScene();
		initCamera();
		initLight();
		initControl();

		addFloor();
		addObjects();

		renderEngine();

		function initScene(){
			//////////////////////////////////////////////////////////////////////////////////
			//		Init
			//////////////////////////////////////////////////////////////////////////////////

			//Error if not WebGL compatible
			if ( WEBGL.isWebGLAvailable() === false ) {
					document.body.appendChild( WEBGL.gepairingebGLErrorMessage() );
			}

			switch(lang){
				case "fr":
					swal({
					  	title: 'Scan OK, patiente un petit peu!',
					  	type: 'info',
					  	footer: 'STP, autorise l\'acces a ta camera!',
					  	showConfirmButton: false,
			  			timer: 1500000
					});
					break;
				case "eng":
					swal({
					  	title: 'Scan OK, please wait',
					  	type: 'info',
					  	footer: 'Please, enable the camera access',
					  	showConfirmButton: false,
			  			timer: 1500000
					});
				break;
			}

			// init renderer
			renderer	= new THREE.WebGLRenderer({
				antialias	: true,
				autoResize : true,
				alpha: true
			});
			
			//Add shadow to renderer
			renderer.shadowMap.type = THREE.PCFSoftShadowMap;
			renderer.shadowMap.enabled = true;

			renderer.setClearColor(new THREE.Color('lightgrey'), 0);
			renderer.setPixelRatio( window.devicePixelRatio );
			renderer.setSize( window.innerWidth, window.innerHeight );
			renderer.domElement.style.position = 'absolute'
			renderer.domElement.style.top = '0px'
			renderer.domElement.style.left = '0px'
			document.body.appendChild( renderer.domElement );

			// array of functions for the rendering loop
			onRenderFcts= [];

			// init arWorldRoot and camera

			arWorldRoot = new THREE.Scene();
		}
		
		function initCamera(){
			//////////////////////////////////////////////////////////////////////////////////
			//		Initialize a basic camera
			//////////////////////////////////////////////////////////////////////////////////

			// Create a camera
			camera = new THREE.PerspectiveCamera( 50, window.innerWidth / window.innerHeight, 1, 1500 );
			camera.position.set( 0, 2, 10 );
			arWorldRoot.add(camera);
		}

		function initLight(){
			var light = new THREE.AmbientLight( 0xffffff ); // soft white light
			arWorldRoot.add( light );
		}

		function initControl(){
			// controls

			controls = new THREE.OrbitControls( camera, renderer.domElement );

			//controls.addEventListener( 'change', render ); // call this only in static arWorldRoots (i.e., if there is no animation loop)

			controls.enableDamping = true; // an animation loop is required when either damping or auto-rotation are enabled
			controls.dampingFactor = 0.25;

			controls.screenSpacePanning = false;

			controls.minDistance = 0;
			controls.maxDistance = 500;

			controls.maxPolarAngle = Math.PI / 2;
		}

		function addObjects(){
			//////////////////////////////////////////////////////////////////////////////////
			//		Add the objects in the arWorldRoot
			//////////////////////////////////////////////////////////////////////////////////

			all = new THREE.Group();
			
			var xsize = 1280;
			var ysize = 720;

			var geometry = new THREE.PlaneGeometry(xsize, ysize);

			var location = window.location.href;
			var directoryPath = location.substring(0, location.lastIndexOf("/")+1);
			var movieMaterial = new ChromaKeyMaterial(directoryPath + 'content/video.mp4', 1280, 720, 0xd432);
			// green: 0xd432
			// white: 0xffff

			videoPlane = new THREE.Mesh( geometry, movieMaterial );
			videoPlane.position.y = 1.2;
			videoPlane.position.x = 0;
			videoPlane.scale.multiplyScalar(1/512);
			//videoPlane.visible = false;
			video.loop = false;

			all.add( videoPlane );	

			onRenderFcts.push(function(delta, now){
				movieMaterial.update();
			})

			//Add desk
			var geometry = new THREE.PlaneGeometry(2, 1);
			var loader = new THREE.TextureLoader().load('content/table.jpg', (imgLoader) => {});
			//Load the image into a custom material
			var material = new THREE.MeshLambertMaterial({
			  map: loader
			});
			
			var desk = new THREE.Mesh(geometry, material);

			desk.position.y = 0.2;
			desk.position.z = 0.2;
			all.add(desk);

			//Load pic1
			var geometry = new THREE.BoxGeometry(1, 1, 0.02);
			var material = new THREE.MeshLambertMaterial();
			pic1 = new THREE.Mesh(geometry, material);
			//Get image from image.jpg
			var imageLoader = new THREE.TextureLoader().load('content/image0.jpg', (imgLoader) => {
				//Rescale and position image
				var targepairingidth = 2;
				var targetHeight = targepairingidth*imgLoader.image.height / imgLoader.image.width;
				pic1.scale.set(targepairingidth, targetHeight, 1.0);
				pic1.position.x = -1;
				pic1.position.z = -0.5;
			});

			//Load the image into a custom material
			material = new THREE.MeshLambertMaterial({
			  map: imageLoader
			});
			//Add material to the image mesh
			pic1.material = material;
			pic1.position.y = 20;
			//pic1.visible = false;

			all.add(pic1);

			//Load pic2
			var geometry = new THREE.BoxGeometry(1, 1, 0.02);
			var material = new THREE.MeshLambertMaterial();
			pic2 = new THREE.Mesh(geometry, material);
			//Get image from image.jpg
			var imageLoader = new THREE.TextureLoader().load('content/image1.jpg', (imgLoader) => {
				//Rescale and position image
				var targepairingidth = 2;
				var targetHeight = targepairingidth*imgLoader.image.height / imgLoader.image.width;
				pic2.scale.set(targepairingidth, targetHeight, 1.0);
				pic2.position.x = 1;
				pic2.position.z = -0.5;
			});

			//Load the image into a custom material
			material = new THREE.MeshLambertMaterial({
			  map: imageLoader
			});
			//Add material to the image mesh
			pic2.material = material;
			pic2.position.y = 20;
			//pic2.visible = false;

			all.add(pic2);

			//link buttons
			var geometry = new THREE.CircleGeometry(0.3, 32);
			var healthLoader = new THREE.TextureLoader().load('content/icon/fb_icon.png', (imgLoader) => {});
			var pairingLoader = new THREE.TextureLoader().load('content/icon/tw_icon.png', (imgLoader) => {});
			var inLoader = new THREE.TextureLoader().load('content/icon/in_icon.png', (imgLoader) => {});
			//Load the image into a custom material
			var healthMaterial = new THREE.MeshLambertMaterial({ map: healthLoader});
			var pairingMaterial = new THREE.MeshLambertMaterial({ map: pairingLoader});
			var inMaterial = new THREE.MeshLambertMaterial({ map: inLoader});
			
			groupButton = new THREE.Group();

			health = new THREE.Mesh(geometry, healthMaterial);
			health.position.x = -1;
			health.visible = false;
			groupButton.add(health);
			pairing = new THREE.Mesh(geometry, pairingMaterial);
			pairing.position.x = 0;
			pairing.position.y = 0.5;
			pairing.visible = false;
			groupButton.add(pairing);
			coinfo = new THREE.Mesh(geometry, inMaterial);
			coinfo.position.x = 1;
			coinfo.visible = false;
			groupButton.add(coinfo);

			groupButton.position.y = 1.7;
			all.add(groupButton);

			all.scale.multiplyScalar(1.5);

			arWorldRoot.add(all);

		}

		function addFloor(){
			/////////////////////////////
			// Floor OBJECT
			/////////////////////////////
			var geometry = new THREE.PlaneGeometry(20, 10);
			var loader = new THREE.TextureLoader().load('content/table.jpg', (imgLoader) => {});
			//Load the image into a custom material
			var material = new THREE.MeshLambertMaterial({
			  map: loader
			});
			
			var floor = new THREE.Mesh(geometry, material);

			floor.position.y = -1;
			floor.rotation.x = -Math.PI/2;
			arWorldRoot.add(floor);
		}

		function renderEngine(){
			//////////////////////////////////////////////////////////////////////////////////
			//		render the whole thing on the page
			//////////////////////////////////////////////////////////////////////////////////

			// render the arWorldRoot
			onRenderFcts.push(function(){
				renderer.render( arWorldRoot, camera );

			})

			// run the rendering loop
			var lastTimeMsec= null
			requestAnimationFrame(function animate(nowMsec){
				// keep looping
				requestAnimationFrame( animate );
				controls.update(); // only required if controls.enableDamping = true, or if controls.autoRotate = true
				// measure time
				lastTimeMsec	= lastTimeMsec || nowMsec-1000/60
				var deltaMsec	= Math.min(200, nowMsec - lastTimeMsec)
				lastTimeMsec	= nowMsec
				// call each update function
				onRenderFcts.forEach(function(onRenderFct){
					onRenderFct(deltaMsec/1000, nowMsec/1000)
				})
			})

			document.addEventListener( 'mousedown', onDocumentMouseDown, false );

			function onDocumentMouseDown( event ) {

				event.preventDefault();

				var raycaster = new THREE.Raycaster();
				var mouse = new THREE.Vector2();

				mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
				mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;

				raycaster.setFromCamera( mouse, camera );

				var videoPlaneArray = [videoPlane];
				var healthArray = [health];
				var pairingArray = [pairing];
				var coinfoArray = [coinfo];

				var videoIntersects = raycaster.intersectObjects( videoPlaneArray );
				var healthIntersects = raycaster.intersectObjects( healthArray );
				var pairingIntersects = raycaster.intersectObjects( pairingArray );
				var coinfoIntersects = raycaster.intersectObjects( coinfoArray );

				if ( healthIntersects.length > 0) {
					window.location.href = 'https://en.wikipedia.org/wiki/Health_effects_of_wine';
				}else if(pairingIntersects.length > 0){
					window.location.href = 'https://www.foodandwine.com/slideshows/15-rules-great-wine-and-food-pairings';
				}else if(coinfoIntersects.length > 0){
					window.location.href = 'https://www.paperoniproductions.com/';
				}else if ( videoIntersects.length > 0) {
					if(video.paused == true){
						video.play();
						isVideoPlay = true;
					}else{
						video.pause();
						isVideoPlay = false;
					}
				}
			}
		}

		function initSequence(){
			time = 0;
			video_time = 0;

			videoStart = false;
			stopAnim = false;

			onRenderFcts.push(function(){
				
				//Init chrono
				time += 0.02;
				video_time = video.currentTime;
				document.getElementById("time").innerHTML = "Time: " + Math.round(time) + " Video time: " + Math.round(video_time);

				//Launch speech
				var start = startVideo;
				if(videoStart == false && Math.round(time) == start ){
					//videoPlane.visible = true;
					video.play();
					videoStart = true;
				}

				//Show Pic1
				var start = startPic1 - 3; 
				var end = startPic1; 
				var t = (video_time-start)/(end-start);
				if(	video_time >= start && video_time < end ){
					t_down = (10*t-10); //t_down goes from -10 to 0
					t_lowered = t_down/3;
					pic1.position.y = -t_lowered*t_lowered*t_lowered +1.5; // cubic function
					//pic1.visible = true;
				}

				//Hide Pic1
				var start = startPic1 + 3; 
				var end = startPic1 + 4; 
				var t = (video_time-start)/(end-start);
				if(	video_time >= start && video_time < end ){
					t_up = (10*t); // t_up goes from 0 to 10
					t_lowered = t_up/3;
					pic1.position.y = -t_lowered*t_lowered*t_lowered +1.5; // cubic function
					if (video_time >= end-0.1){
						//pic1.visible = false;
					}
				}

				//Show Pic2 
				var start = startPic2 - 3; 
				var end = startPic2; 
				var t = (video_time-start)/(end-start);
				if(	video_time >= start && video_time < end ){
					t_down = (10*t-10); //t_down goes from -10 to 0
					t_lowered = t_down/3;
					pic2.position.y = -t_lowered*t_lowered*t_lowered +1.5; // cubic function
					//pic2.visible = true;
				}

				//Hide Pic2 
				var start = startPic2 + 3; 
				var end = startPic2 + 6; 
				var t = (video_time-start)/(end-start);
				if(	video_time >= start && video_time < end ){
					t_up = (10*t); // t_up goes from 0 to 10
					t_lowered = t_up/3;
					pic2.position.y = -t_lowered*t_lowered*t_lowered +1.5; // cubic function
					if (video_time >= end-0.1){
						//pic2.visible = false;
					}
				}

				//button 1
				var start = startButton; 
				var end = startButton+0.5; 
				var t = (video_time-start)/(end-start);
				if(	video_time >= start && video_time < end ){
					t_down = (2-1*t); //t_down goes from 3 to 1;
					coinfo.scale.set(t_down,t_down,t_down);
					coinfo.visible = true;
				}
				//button 2
				var start = startButton+0.2; 
				var end = startButton+0.7; 
				var t = (video_time-start)/(end-start);
				if(	video_time >= start && video_time < end ){
					t_down = (2-1*t); //t_down goes from 3 to 1;
					pairing.scale.set(t_down,t_down, t_down);
					pairing.visible = true;
				}
				//button 3
				var start = startButton+0.4; 
				var end = startButton+0.9; 
				var t = (video_time-start)/(end-start);
				if(	video_time >= start && video_time < end ){
					t_down = (2-1*t); //t_down goes from 3 to 1;
					health.scale.set(t_down,t_down, t_down);
					health.visible = true;
				}

				// Stop speech
				var start = video.duration;
				if(Math.round(video_time) == start && stopAnim == false){
					videoPlane.visible = true;
					speechStopped = true;
					isVideoPlay == false;
					video.pause();
					time = 63;
					stopAnim = true;
					groupButton.position.z = 0.1;
					groupButton.visible = true;
				}

			})
		}

		function test(test_var){
			document.getElementById("test").innerHTML = "Test: " + test_var;
		}

		function loadOK(lang){
			switch(lang){
				case "fr":
					swal({
					  	title: 'C\'est pret! Pointe le QR code avec ta camera',
					  	type: 'success',
					  	confirmButtonText: 'OK',
					  	footer: 'STP, autorise l\'acces a ta camera!',
					  	showLoaderOnConfirm: true,
							preConfirm: () => {
								video.play();
								video.pause();
								initSequence();
						}
					});
					break;
				case "eng":
					swal({
					  	title: 'Ready, point the QR code with your camera',
					  	type: 'success',
					  	confirmButtonText: 'OK',
					  	footer: 'Please, enable the camera access',
					  	showLoaderOnConfirm: true,
							preConfirm: () => {
								video.play();
								video.pause();
								initSequence();
						}
					});
				break;
			}
		}
		</script>
	</body>
</html>